<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DioGIS ~ Version 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://js.arcgis.com/4.28/"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
  <style>
    html, body, #mapview {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }
    #buttons {
      position: fixed;
      top: 0px;
      left: 0px;
      z-index: 99;
      background: rgba(255, 255, 255, 0.3);
      padding: 5px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.312);
      display: flex;
      justify-content: space-between;
    }
    #buttons select {
      margin-right: 10px;
      padding: 5px 10px;
      font-size: 12px;
    }
    #refreshBtn, #printBtn {
      position: absolute;
      background: rgba(255, 255, 255, 0.3);
      padding: 5px 10px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      text-align: center;
    }
    #refreshBtn { top: 260px; right: 10px; }
    #printBtn { top: 310px; right: 10px; }

    #legendContainer {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 99;
      background: rgba(255, 255, 255, 0.3);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /* Updated CSS for legend styling */
    #legendDiv .esri-legend {
      background: rgba(255, 255, 255, 0.3) !important; /* Override default background */
      padding: 5px !important;
      min-width: auto !important;
      width: auto !important;
      max-width: 250px;
      font-size: 12px; /* General font size within the legend */
    }

    #legendDiv .esri-legend__layer {
      margin: 5px 0 !important;
    }

    #legendDiv .esri-legend__layer-caption {
      font-size: 16px !important;
      font-weight: bold !important;
      white-space: pre-wrap !important; /* For line breaks */
    }

    /* Target the labels next to the symbols ("Increase", "Decrease") */
    #legendDiv .esri-legend__symbol-item-label {
      font-size: 18px !important;
    }

    #popupPanel {
      position: absolute;
      right: 5px;
      top: 5px;
      width: 300px;
      background: white;
      padding: 0px 10px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      z-index: 100;
      display: none;
    }

    #popupCloseBtn {
      position: absolute;
      top: 5px;
      right: 8px;
      cursor: pointer;
      color: #888;
      font-weight: bold;
    }

    .back-button {
      position: fixed;
      top: 0px;
      left: 45%;
      padding: 8px 15px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 5px;
      background-color:  rgba(255, 255, 255, 0.3);
      cursor: pointer;
      font-size: 16px;
      z-index: 1000;
    }

    .back-button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }

    @media print {
      body, #mapview {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      #buttons, #refreshBtn, #printBtn, #legendContainer, #popupPanel {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="buttons">
    <button class="back-button" onclick="window.parent.showMainPage()">Back to Versions</button>
    <select id="grpDropdown"><option value="">Select GRP ID</option></select>
    <select id="lstservices">
      <option value="WHITE">White background</option>
    </select>
    <label for="grpLayerCheckbox">GRP Layer Visible</label>
    <input type="checkbox" id="grpLayerCheckbox" checked />
    <button class="back-button" onclick="window.parent.showMainPage()">Back to Versions</button>
  </div>
  <div id="mapview"></div>
  <div id="refreshBtn">Refresh</div>
  <div id="printBtn">Print</div>
  <div id="legendContainer"><div id="legendDiv"></div></div>

  <div id="popupPanel">
    <div id="popupCloseBtn">✖</div>
    <div id="popupContent"></div>
  </div>

  <script>
    let mapview, map, geojsonLayer, grpGeojsonLayer, vcGeojsonLayer, treeGeojsonLayer;

    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/request",
      "esri/layers/MapImageLayer",
      "esri/layers/GeoJSONLayer",
      "esri/symbols/SimpleFillSymbol",
      "esri/renderers/SimpleRenderer",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/widgets/Legend",
      "esri/widgets/Print",
      "esri/widgets/Zoom"
    ], function (
      Map, MapView, esriRequest, MapImageLayer, GeoJSONLayer, SimpleFillSymbol, SimpleRenderer, SimpleMarkerSymbol, Legend, Print, Zoom
    ) {
      const serviceURL = "https://server.arcgisonline.com/arcgis/rest/?f=json";
      const selectedIndexes = [2, 5, 7];

      const lstservices = document.getElementById("lstservices");
      const grpDropdown = document.getElementById("grpDropdown");
      const popupPanel = document.getElementById("popupPanel");
      const popupContent = document.getElementById("popupContent");
      const popupCloseBtn = document.getElementById("popupCloseBtn");
      const grpLayerCheckbox = document.getElementById("grpLayerCheckbox");

      popupCloseBtn.addEventListener("click", () => {
        popupPanel.style.display = "none";
      });

      map = new Map({ basemap: null });

      mapview = new MapView({
        container: "mapview",
        map: map,
        center: [46.66302550542527, 24.72617449457473],
        scale: 580000,
        background: { color: "white" }
      });

      mapview.ui.remove("zoom");

      geojsonLayer = new GeoJSONLayer({
        url: "http://localhost:8080/data/AOI.geojson",
        title: "AOI",
        renderer: new SimpleRenderer({
          symbol: new SimpleFillSymbol({
            color: [255, 255, 0, 0],
            outline: { color: [125, 125, 125, 1], width: 1 }
          })
        })
      });

      grpGeojsonLayer = new GeoJSONLayer({
        url: "http://localhost:8080/geojson/AOI_splitted.geojson",
        title: "GRP Polygons",
        renderer: new SimpleRenderer({
          symbol: new SimpleFillSymbol({
            color: [0, 0, 255, 0.1],
            outline: { color: [0, 0, 0, 0.2], width: 1 }
          })
        })
      });

      vcGeojsonLayer = new GeoJSONLayer({
        url: "http://localhost:8080/geojson/dummy_binary.geojson",
        title: "VC Layer",
        renderer: {
          type: "unique-value",
          field: "ndvi02",
          uniqueValueInfos: [
            {
              value: 0,
              symbol: {
                type: "simple-fill",
                color: [255, 0, 0, 0.5],
                outline: { color: [255, 0, 0, 0.1], width: 1 }
              },
              label: "Decrease"
            },
            {
              value: 1,
              symbol: {
                type: "simple-fill",
                color: [0, 255, 0, 0.5],
                outline: { color: [0, 255, 0, 0.1], width: 1 }
              },
              label: "Increase"
            }
          ]
        }
      });

      treeGeojsonLayer = new GeoJSONLayer({
        url: "http://localhost:8080/geojson/dummy_trees.geojson",
        title: "Trees",
        renderer: new SimpleRenderer({
          symbol: new SimpleMarkerSymbol({
            style: "circle", // "square", "cross"
            color: [80, 80, 80, 0.9], // Dark grey color (RGBA)
            size: 2, // Adjust the size of the points as needed
            outline: null // Remove the outline
          })
        })
      });

      map.addMany([geojsonLayer, grpGeojsonLayer, treeGeojsonLayer, vcGeojsonLayer]);

      function populateGRPDropdown() {
        grpGeojsonLayer.queryFeatures().then((results) => {
          grpDropdown.innerHTML = '<option value="">Select GRP ID</option>';
          results.features.forEach((feature) => {
            const id = feature.attributes.id;
            const option = document.createElement("option");
            option.value = id;
            option.textContent = id;
            grpDropdown.appendChild(option);
          });
        });
      }

      grpGeojsonLayer.on("layerview-create", populateGRPDropdown);

      // Define ONCE globally (reused across all popups)
      const formatNumber = (value, decimals = 2) => {
        const num = parseFloat(value);
        return isNaN(num) ? "0".repeat(decimals ? decimals + 1 : 1) : num.toFixed(decimals);
      };

      grpDropdown.addEventListener("change", function () {
        const selectedID = this.value;

        if (selectedID) {
          // Create a definition expression to filter for the selected GRP ID
          const definitionExpression = `id = '${selectedID}'`;

          // Apply the definition expression to the grpGeojsonLayer
          grpGeojsonLayer.definitionExpression = definitionExpression;

          // Zoom to the extent of the selected feature
          grpGeojsonLayer.queryFeatures({
            where: definitionExpression,
            returnGeometry: true
          }).then((results) => {
            if (results.features.length > 0) {
              mapview.goTo(results.features[0].geometry.extent.expand(1.5));
              showPopup(results.features[0].attributes);
            } else {
              popupPanel.style.display = "none";
            }
          }).catch(function(error) {
            console.error("Error querying features:", error);
          });
        } else {
          // If no GRP ID is selected (default option), clear the definition expression
          grpGeojsonLayer.definitionExpression = null;
          popupPanel.style.display = "none";
        }
      });

      function showPopup(attrs) {
        popupContent.innerHTML = `
          <h3>GRP ID: ${attrs.id || "N/A"}</h3>
          <p><strong>Area:</strong> ${formatNumber(attrs.AREA, 0)} m²</p>
          <p><strong>Decrease:</strong> ${formatNumber(attrs.VC_decrease)}%</p>
          <p><strong>Increase:</strong> ${formatNumber(attrs.VC_increase)}%</p>
          <p><strong>N tree:</strong> ${attrs.Tree_count || "0"}</p>
          `;
        popupPanel.style.display = "block";
      }

      document.getElementById("printBtn").addEventListener("click", () => window.print());

      document.getElementById("refreshBtn").addEventListener("click", () => {
        mapview.goTo({ center: [46.66302550542527, 24.72617449457473], scale: 580000 });
        populateGRPDropdown();
        popupPanel.style.display = "none";
        grpGeojsonLayer.definitionExpression = null; // Clear the definition expression on refresh
        grpDropdown.value = ""; // Reset the dropdown
      });

      const zoomWidget = new Zoom({ view: mapview });
      mapview.ui.add(zoomWidget, "bottom-right");

      const legend = new Legend({
        view: mapview,
        container: "legendDiv",
        layerInfos: [
          {
            layer: vcGeojsonLayer,
            title: "Vegetation Cover Change\n(one month)"
          },
          {
            layer: treeGeojsonLayer,
            title: "Trees",
            symbolInfos: [{
              symbol: new SimpleMarkerSymbol({
                style: "circle",
                color: [80, 80, 80, 0.9],
                size: 2,
                outline: null
              })
            }]
          }
        ]
      });

      grpLayerCheckbox.addEventListener("change", function () {
        grpGeojsonLayer.visible = this.checked;
        if (!this.checked) {
          grpGeojsonLayer.definitionExpression = null; // Clear filter if layer is hidden
        } else if (grpDropdown.value) {
          // Re-apply the filter if the layer is made visible again and a GRP ID is selected
          grpDropdown.dispatchEvent(new Event('change'));
        }
      });

      esriRequest(serviceURL, { responseType: "json" }).then(response => {
        const services = response.data.services;
        selectedIndexes.forEach(i => {
          if (i < services.length) {
            const option = document.createElement("option");
            option.textContent = services[i].name;
            option.value = services[i].name;
            lstservices.appendChild(option);
          }
        });
        if (lstservices.options.length > 0) {
          loadServiceLayer(lstservices.options[0].value);
        }
      });

      lstservices.addEventListener("change", function () {
        loadServiceLayer(this.value);
      });

      function loadServiceLayer(serviceName) {
        map.removeAll();
        if (serviceName === "WHITE") {
          map.basemap = null;
          mapview.background = { color: "white" };
        } else {
          const layerUrl = `https://server.arcgisonline.com/arcgis/rest/services/${serviceName}/MapServer`;
          const imageryLayer = new MapImageLayer({ url: layerUrl });
          // Set the imageryLayer as the basemap
          map.basemap = {
            baseLayers: [imageryLayer]
          };
        }
        map.addMany([geojsonLayer, grpGeojsonLayer, treeGeojsonLayer, vcGeojsonLayer]); // Ensure tree layer is added back
        populateGRPDropdown();
        // Important Change: DO NOT clear the definition expression here
        // grpGeojsonLayer.definitionExpression = null;
        // grpDropdown.value = "";
      }
    });
  </script>
</body>
</html>